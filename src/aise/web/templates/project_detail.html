{% extends "layout.html" %}
{% block content %}
<section id="project-page" class="card" data-project-id="{{ project.info.project_id }}">
  <h1>{{ project.info.project_name }}</h1>
  <p>ID: {{ project.info.project_id }} | 状态: {{ project.info.status }} | 模式: {{ project.info.development_mode }}</p>
</section>

<section class="split">
  <article class="card">
    <h2>下发新需求</h2>
    <form id="requirement-form" method="post" action="/projects/{{ project.info.project_id }}/requirements" class="stack">
      <label>需求内容</label>
      <textarea name="requirement_text" rows="6" required placeholder="输入新需求"></textarea>
      <button class="btn" type="submit">提交并运行工作流</button>
    </form>
  </article>
  <article class="card">
    <h2>工作流节点</h2>
    <ol>
      {% for node in project.workflow_nodes %}
      <li>
        <strong>{{ node.name }}</strong><br>
        任务: {{ node.tasks|join(", ") }}<br>
        评审: {{ node.review_gate or "无" }}
      </li>
      {% endfor %}
    </ol>
  </article>
</section>

<section class="card">
  <h2>历时需求</h2>
  <ul id="requirements-list">
    {% if project.requirements %}
    {% for req in project.requirements %}
    <li>{{ req.created_at }} - {{ req.text }}</li>
    {% endfor %}
    {% else %}
    <li>暂无需求历史。</li>
    {% endif %}
  </ul>
</section>

<section class="card">
  <h2>工作流执行记录</h2>
  <table>
    <thead>
      <tr>
        <th>执行ID</th>
        <th>时间</th>
        <th>需求摘要</th>
        <th>查看</th>
      </tr>
    </thead>
    <tbody id="runs-tbody">
      {% if project.runs %}
      {% for run in project.runs %}
      <tr>
        <td>{{ run.run_id }}</td>
        <td>{{ run.started_at }}</td>
        <td>{{ run.requirement_text[:80] }}</td>
        <td><a href="/projects/{{ project.info.project_id }}/runs/{{ run.run_id }}">详情</a></td>
      </tr>
      {% endfor %}
      {% else %}
      <tr>
        <td colspan="4">暂无执行记录。</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</section>
{% endblock %}
